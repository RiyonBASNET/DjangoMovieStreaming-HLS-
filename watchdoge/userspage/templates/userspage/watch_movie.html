{% extends 'user_base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
<title>Watch {{movie.title}}</title>
<!-- cdn for Video -->
<!-- <link href="https://vjs.zencdn.net/8.0.4/video-js.css" rel="stylesheet" />
<script src="https://vjs.zencdn.net/8.0.4/video.min.js"></script> -->

<!-- hls.js (for browsers that don't support HLS natively) -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- Include Plyr -->
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const video = document.getElementById('player');
        const source = "{{MEDIA_URL}}{{ movie.hls_path }}";
        const defaultOptions = {};

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(source);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, function () {
                video.play();
            });
            hls.on(Hls.Events.ERROR, function (event, data) {
                if (data.fatal) {
                    alert("Failed to load video.");
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Safari and iOS
            video.src = source;
            video.addEventListener('loadedmetadata', () => {
                video.play();
            });
        }


        const player = new Plyr(video, defaultOptions);
    });
</script>
<!-- Plyr -->
<style>
    #player {
        width: 100%;
        height: auto;
        max-width: auto;
        max-height: 100vh;
        object-fit: contain;
    }
</style>
{% endblock %}

{% block main_content %}
<div class="container mt-1 mb-3 p-3">
    <div class="row g-0 d-flex justify-content-center mb-4 p-1">
        <!-- Video Element -->
        <div class="video-wrapper">
            <div class="player">

                {% if movie.status == "uploaded" %}
                <h3 class="text-info">Uploaded. Waiting for conversion...</h3>
                {% elif movie.status == "processing" %}
                <h3 class="text-warning">Processingâ€¦ please wait</h3>
                {% elif movie.status == "ready" %}
                <video id="player" controls crossorigin playsinline poster="{{ movie.poster.url }}">

                    <source src="{{ MEDIA_URL }}{{ movie.hls_path }}" type="application/x-mpegURL">
                </video>

                {% elif movie.status == "failed" %}
                <h3 class="text-danger">Conversion failed. Contact admin.</h3>
                {% endif %}

            </div>

        </div>

    </div>
    <div class="row mx-0 g-0 d-flex justify-content-center detail-box mt-2 p-2 shadow">
        <div class="col-6 col-md-4 p-2 d-flex justify-content-center">
            <img src="{{movie.poster.url}}" class="img-fluid rounded-start" alt="{{movie.title}}" width="200">
        </div>
        <div class="col-sm-6 col-md-8 d-flex align-items-center">
            <div class="card-body p-4 movie-detail">
                <h2 class="card-title">{{movie.title}}</h2>

                <div class="my-3 fav-watch-trailer">
                    {% if user.is_authenticated %}
                    <a href="#" class="btn btn-danger">
                        <i class="fal fa-heart"></i> Favorite</a>
                    <a href="#" class="btn btn-secondary">
                        <i class="far fa-plus"></i> Add to Watchlist</a>
                    {% else %}
                    <a href="#" class="btn btn-danger disabled">
                        <i class="fal fa-heart"></i> Favorite</a>
                    <a href="#" class="btn btn-secondary disabled">
                        <i class="far fa-plus"></i> Add to Watchlist</a>
                    {% endif %}


                </div>
                <p><strong>Overview:</strong></p>
                <p class="card-text">{{movie.description}}</p>
                <h6 class="card-text"><strong>Release Year:</strong> {{movie.release_year}}</h6>
                <p class="card-text">
                    <strong>Genres:</strong> {% for genre in movie.genres.all %}
                    {{genre.name}}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                </p>
                <p class="card-text"><strong>Duration:</strong> {{movie.duration_minutes}} mins</p>
            </div>
        </div>
    </div>

    <br>
    <br class="my-2">

    <!-- recommended_movies -->
    <div class="container px-0 mb-2">

        <h1 class="mt-2 recomm-title">You may also like</h1>
        <div class="row row-cols-1 row-cols-md-5 g-4 m-3">
            {% for movie in recommended_movies %}
            <div class="col recomm-list">
                <a href="{% url 'movie-details' movie.id %}" class="text-decoration-none">
                    <div class="card movie-card">
                        <div class="card-header p-2 d-flex justify-content-center">
                            <img src="{{ movie.poster.url }}" class="card-img-top " alt="{{ movie.title }}"
                                style="max-width: 150px;height: 200px;">
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-truncate"><strong>{{ movie.title }}</strong></h5>
                            <p class="card-text"><small class="text-body">Released Year:
                                    {{movie.release_year}}</small>
                            </p>

                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

</div>
<!-- Initialize -->
<script>
    const player = new Plyr('#player', {
        speed: { selected: 1, options: [0.5, 1, 1.5, 2] }
    });
</script>
{% endblock %}


<!-- <video class="card-image-top" width="100%" height="480" controls>
                    <source src="{{ movie.file.url }}" type="video/mp4">
                    Your browser does not support the video tag.
                </video> -->

<!-- <video id="my-video" class="video-js" controls preload="auto" width="640" height="360"
                    poster="{{ movie.poster.url }}" data-setup="{}">
                    <source src="{{ movie.file.url }}" type="video/mp4" />
                    Your browser does not support the video tag.
                </video> -->

<!-- <source src="{{ movie.file.url }}" type="video/mp4" /> -->